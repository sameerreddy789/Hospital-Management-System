<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="../logo.png">
  <title>Manage Doctors - TumourCare</title>
  <link rel="stylesheet" href="../css/style.css">
  <link rel="stylesheet" href="../css/admin-layout.css">
</head>

<body class="dashboard-body">
  <!-- Top Navbar -->
  <nav class="dashboard-topnav">
    <div class="topnav-inner">
      <a href="dashboard.html" class="topnav-brand">
        <img src="../logo.png" alt="TumourCare Logo">
        <span>TumourCare</span>
      </a>
      <button class="topnav-toggle" id="navToggle" aria-label="Toggle navigation">&#9776;</button>
      <div class="topnav-links" id="navLinks">
        <a href="dashboard.html">
          <svg viewBox="0 0 24 24">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            <polyline points="9 22 9 12 15 12 15 22"></polyline>
          </svg>
          Dashboard
        </a>
        <a href="manage-doctors.html" class="active">
          <svg viewBox="0 0 24 24">
            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
            <circle cx="9" cy="7" r="4"></circle>
            <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
          </svg>
          Manage Doctors
        </a>
        <a href="manage-patients.html">
          <svg viewBox="0 0 24 24">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
            <circle cx="9" cy="7" r="4"></circle>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
          </svg>
          Manage Patients
        </a>
        <a href="notifications.html">
          <svg viewBox="0 0 24 24">
            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
          </svg>
          Notifications <span id="notifBadge" class="nav-badge" style="display:none;">0</span>
        </a>
      </div>
      <a href="#" id="logoutBtn" class="topnav-logout" title="Logout">
        <svg viewBox="0 0 24 24">
          <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
          <polyline points="16 17 21 12 16 7"></polyline>
          <line x1="21" y1="12" x2="9" y2="12"></line>
        </svg>
        <span>Logout</span>
      </a>
    </div>
  </nav>

  <main class="main-content">
    <header class="page-header">
      <div>
        <h1>Manage Doctors</h1>
        <div class="breadcrumb">Oncologists directory and pending approval requests</div>
      </div>
    </header>

    <div class="page-body">

      <!-- Pending Doctor Requests -->
      <div class="dashboard-section">
        <div class="section-header">
          <h2>
            <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none"
              style="vertical-align:middle;margin-right:8px;">
              <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <polyline points="16 11 18 13 22 9"></polyline>
            </svg>
            Pending Doctor Requests
          </h2>
        </div>
        <div id="pendingDoctorsList" class="list-container">
          <div class="skeleton skeleton-card"></div>
        </div>
      </div>

      <!-- Add New Doctor -->
      <div class="dashboard-section">
        <div class="section-header">
          <h2>
            <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none"
              style="vertical-align:middle;margin-right:8px;">
              <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <line x1="19" y1="8" x2="19" y2="14"></line>
              <line x1="22" y1="11" x2="16" y2="11"></line>
            </svg>
            Add New Doctor
          </h2>
        </div>
        <div class="card" style="margin-top:0.5rem;">
          <div id="addMessage" class="message" style="display:none;"></div>
          <form id="addDoctorForm" novalidate>
            <div class="form-group">
              <label for="doctorName">Full Name</label>
              <input type="text" id="doctorName" required>
            </div>
            <div class="form-group">
              <label for="doctorEmail">Email</label>
              <input type="email" id="doctorEmail" required>
            </div>
            <div class="form-group">
              <label for="doctorPassword">Temporary Password</label>
              <div class="password-wrapper">
                <input type="password" id="doctorPassword" required>
                <button type="button" class="password-toggle" aria-label="Toggle password visibility">&#128065;</button>
              </div>
            </div>
            <div class="form-group">
              <label for="specialization">Specialization</label>
              <input type="text" id="specialization" placeholder="e.g. Surgical Oncology, Radiation Oncology">
            </div>
            <button type="submit" class="btn btn-primary" id="addBtn">Add Doctor</button>
          </form>
        </div>
      </div>

      <!-- Active Doctors List -->
      <div class="dashboard-section">
        <div class="section-header">
          <h2>
            <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none"
              style="vertical-align:middle;margin-right:8px;">
              <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
            Active Doctors
          </h2>
          <div class="section-actions">
            <input type="text" id="searchInput" placeholder="Search doctors..." class="search-input">
          </div>
        </div>
        <div id="doctorList" class="list-container">
          <div class="skeleton skeleton-card"></div>
          <div class="skeleton skeleton-card"></div>
        </div>
      </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <script src="../js/firebase-config.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/validation.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/auth-guard.js"></script>
    <script src="../js/firestore.js"></script>
    <script src="../js/search-filter.js"></script>
    <script>
      requireAuth('admin').then(function (user) {
        var listEl = document.getElementById('doctorList');
        var pendingEl = document.getElementById('pendingDoctorsList');
        var addMsg = document.getElementById('addMessage');
        var addBtn = document.getElementById('addBtn');
        var allDoctors = [];

        function getEmptyState(title, message, icon) {
          return '<div class="empty-state">' +
            '<div class="empty-state-icon">' + icon + '</div>' +
            '<h3>' + title + '</h3>' +
            '<p>' + message + '</p>' +
            '</div>';
        }

        // ========== Pending Doctor Requests ==========
        function renderPendingDoctors(users) {
          if (users.length === 0) {
            pendingEl.innerHTML = getEmptyState('No Pending Requests',
              'All doctor registration requests have been processed.',
              '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M8 12l3 3 5-5"></path></svg>');
            return;
          }
          pendingEl.innerHTML = '';
          users.forEach(function (u) {
            var card = createElement('div', { className: 'card list-row' });
            var initials = (u.name || '?').split(' ').map(function (w) { return w[0]; }).join('').toUpperCase().slice(0, 2);
            var spec = u.specialization ? ' <span class="text-muted">' + escapeHtml(u.specialization) + '</span>' : '';
            var dateStr = u.createdAt ? new Date(u.createdAt.seconds * 1000).toLocaleDateString() : '';
            card.innerHTML = '<div class="list-row-info">' +
              '<div class="list-row-avatar" style="background:linear-gradient(135deg,#f59e0b,#d97706);">' + initials + '</div>' +
              '<div><strong>' + escapeHtml(u.name) + '</strong> <span class="badge badge-info">Doctor</span>' + spec +
              '<br><span class="text-muted">' + escapeHtml(u.email) + ' &middot; ' + dateStr + '</span></div>' +
              '</div>' +
              '<div class="list-row-actions" style="display:flex;gap:0.4rem;">' +
              '<button class="btn btn-success btn-sm approve-btn" data-uid="' + u.id + '">&#10003; Approve</button>' +
              '<button class="btn btn-danger btn-sm reject-btn" data-uid="' + u.id + '">&#10007; Reject</button>' +
              '</div>';
            card.querySelector('.approve-btn').addEventListener('click', function () {
              var uid = this.getAttribute('data-uid');
              this.classList.add('btn-loading');
              approveUser(uid).then(function () {
                showToast('Doctor approved successfully!', 'success');
                loadDoctors();
              }).catch(function () {
                showToast('Failed to approve doctor.', 'error');
              });
            });
            card.querySelector('.reject-btn').addEventListener('click', function () {
              var uid = this.getAttribute('data-uid');
              if (!confirm('Are you sure you want to reject this doctor registration?')) return;
              this.classList.add('btn-loading');
              rejectUser(uid).then(function () {
                showToast('Registration rejected.', 'info');
              }).catch(function () {
                showToast('Failed to reject.', 'error');
              });
            });
            pendingEl.appendChild(card);
          });
        }

        // Listen for pending doctor approvals
        db.collection('users')
          .where('status', '==', 'pending')
          .where('role', '==', 'doctor')
          .onSnapshot(function (snap) {
            var pending = [];
            snap.forEach(function (doc) {
              var d = doc.data();
              d.id = doc.id;
              pending.push(d);
            });
            pending.sort(function (a, b) {
              var ta = a.createdAt ? a.createdAt.seconds : 0;
              var tb = b.createdAt ? b.createdAt.seconds : 0;
              return tb - ta;
            });
            renderPendingDoctors(pending);
          }, function (err) {
            pendingEl.innerHTML = getEmptyState('Could Not Load',
              'Error loading pending requests.',
              '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>');
          });

        // ========== Active Doctors ==========
        function renderDoctors(doctors) {
          if (doctors.length === 0) {
            listEl.innerHTML = getEmptyState('No Doctors Yet',
              'Add your first oncologist using the form above.',
              '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-3-3.87"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path></svg>');
            return;
          }
          listEl.innerHTML = '';
          doctors.forEach(function (doc) {
            var card = createElement('div', { className: 'card list-row' });
            var initials = (doc.name || '?').split(' ').map(function (w) { return w[0]; }).join('').toUpperCase().slice(0, 2);
            var joinDate = doc.createdAt ? new Date(doc.createdAt.seconds * 1000).toLocaleDateString() : 'N/A';
            var spec = doc.specialization ? '<span class="badge badge-info">' + escapeHtml(doc.specialization) + '</span>' : '';
            card.innerHTML = '<div class="list-row-info">' +
              '<div class="list-row-avatar doctor-avatar"><span class="status-dot status-online"></span>' + initials + '</div>' +
              '<div><strong>Dr. ' + escapeHtml(doc.name) + '</strong> ' + spec +
              '<br><span class="text-muted">' + escapeHtml(doc.email) + ' &middot; Joined ' + joinDate + '</span></div>' +
              '</div>';
            listEl.appendChild(card);
          });
        }

        function loadDoctors() {
          getDoctorList().then(function (doctors) {
            allDoctors = doctors;
            renderDoctors(doctors);
          });
        }
        loadDoctors();

        document.getElementById('searchInput').addEventListener('input', function () {
          renderDoctors(filterByText(allDoctors, this.value, 'name'));
        });

        // Password toggle
        document.querySelectorAll('.password-toggle').forEach(function (btn) {
          btn.addEventListener('click', function () {
            var input = this.previousElementSibling;
            var isPassword = input.type === 'password';
            input.type = isPassword ? 'text' : 'password';
            this.innerHTML = isPassword ? '&#128064;' : '&#128065;';
          });
        });

        // Add doctor form
        document.getElementById('addDoctorForm').addEventListener('submit', function (e) {
          e.preventDefault();
          clearFieldErrors(this);
          addMsg.style.display = 'none';

          var name = document.getElementById('doctorName').value.trim();
          var email = document.getElementById('doctorEmail').value.trim();
          var password = document.getElementById('doctorPassword').value;
          var specialization = document.getElementById('specialization').value.trim();

          var result = validateForm([
            { value: name, fieldName: 'DoctorName', validators: [validateRequired] },
            { value: email, fieldName: 'DoctorEmail', validators: [validateRequired, validateEmail] },
            { value: password, fieldName: 'DoctorPassword', validators: [validateRequired, validatePassword] }
          ]);

          if (!result.isValid) {
            for (var field in result.errors) {
              var id = field.charAt(0).toLowerCase() + field.slice(1);
              var input = document.getElementById(id);
              if (input) showFieldError(input, result.errors[field]);
            }
            return;
          }

          addBtn.classList.add('btn-loading');
          firebase.auth().createUserWithEmailAndPassword(email, password)
            .then(function (cred) {
              return db.collection('users').doc(cred.user.uid).set({
                name: name,
                email: email,
                role: 'doctor',
                specialization: specialization,
                status: 'active',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
              });
            })
            .then(function () {
              addBtn.classList.remove('btn-loading');
              showToast('Doctor added successfully!', 'success');
              document.getElementById('addDoctorForm').reset();
              loadDoctors();
            })
            .catch(function (err) {
              addBtn.classList.remove('btn-loading');
              showMessage(addMsg, err.message || 'Failed to add doctor.', 'error');
            });
        });

        document.getElementById('logoutBtn').addEventListener('click', function (e) { e.preventDefault(); logoutUser(); });

        var navToggle = document.getElementById('navToggle');
        var navLinks = document.getElementById('navLinks');
        if (navToggle && navLinks) {
          navToggle.addEventListener('click', function () { navLinks.classList.toggle('open'); });
        }
      });
    </script>
  </main>
</body>

</html>