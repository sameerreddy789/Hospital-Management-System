<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="../logo.png">
  <title>Admin Dashboard - TumourCare</title>
  <link rel="stylesheet" href="../css/style.css">
  <link rel="stylesheet" href="../css/admin-layout.css">
</head>

<body class="dashboard-body">
  <!-- Top Navbar -->
  <nav class="dashboard-topnav">
    <div class="topnav-inner">
      <a href="dashboard.html" class="topnav-brand">
        <img src="../logo.png" alt="TumourCare Logo">
        <span>TumourCare</span>
      </a>

      <button class="topnav-toggle" id="navToggle" aria-label="Toggle navigation">&#9776;</button>

      <div class="topnav-links" id="navLinks">
        <a href="dashboard.html" class="active">
          <svg viewBox="0 0 24 24">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            <polyline points="9 22 9 12 15 12 15 22"></polyline>
          </svg>
          Dashboard
        </a>
        <a href="manage-doctors.html">
          <svg viewBox="0 0 24 24">
            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
            <circle cx="9" cy="7" r="4"></circle>
            <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
          </svg>
          Manage Doctors
        </a>
        <a href="manage-patients.html">
          <svg viewBox="0 0 24 24">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
            <circle cx="9" cy="7" r="4"></circle>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
          </svg>
          Manage Patients
        </a>
        <a href="notifications.html">
          <svg viewBox="0 0 24 24">
            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
          </svg>
          Notifications <span id="notifBadge" class="nav-badge" style="display:none;">0</span>
        </a>
      </div>

      <a href="#" id="logoutBtn" class="topnav-logout" title="Logout">
        <svg viewBox="0 0 24 24">
          <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
          <polyline points="16 17 21 12 16 7"></polyline>
          <line x1="21" y1="12" x2="9" y2="12"></line>
        </svg>
        <span>Logout</span>
      </a>
    </div>
  </nav>

  <main class="main-content">
    <header class="page-header">
      <div>
        <h1>Admin Dashboard</h1>
        <div class="breadcrumb">Overview of hospital operations and care coordination</div>
      </div>
    </header>

    <div class="page-body">

      <!-- Summary Stats -->
      <div class="summary-cards">
        <div class="summary-card">
          <div class="summary-card-icon" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6;">
            <svg viewBox="0 0 24 24" width="32" height="32" stroke="currentColor" stroke-width="2" fill="none">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
          </div>
          <div>
            <h3>Total Patients</h3>
            <p class="stat" id="totalPatientCount">0</p>
          </div>
        </div>
        <div class="summary-card">
          <div class="summary-card-icon" style="background: rgba(245, 158, 11, 0.1); color: #f59e0b;">
            <svg viewBox="0 0 24 24" width="32" height="32" stroke="currentColor" stroke-width="2" fill="none">
              <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
            </svg>
          </div>
          <div>
            <h3>Pending Requests</h3>
            <p class="stat" id="pendingCount">0</p>
          </div>
        </div>
        <div class="summary-card">
          <div class="summary-card-icon" style="background: rgba(16, 185, 129, 0.1); color: #10b981;">
            <svg viewBox="0 0 24 24" width="32" height="32" stroke="currentColor" stroke-width="2" fill="none">
              <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
          </div>
          <div>
            <h3>Oncologists</h3>
            <p class="stat" id="doctorCount">0</p>
          </div>
        </div>
      </div>

      <!-- Section 1: Patient Requests -->
      <div class="dashboard-section">
        <div class="section-header">
          <h2>
            <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none"
              style="vertical-align:middle;margin-right:8px;">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
            </svg>
            Patient Requests
          </h2>
          <div class="section-actions">
            <input type="text" id="searchInput" placeholder="Search by patient name..." class="search-input">
          </div>
        </div>
        <div id="submissionList" class="list-container">
          <div class="skeleton skeleton-card"></div>
          <div class="skeleton skeleton-card"></div>
        </div>
        <div id="submissionPagination" class="pagination-controls" style="display:none;"></div>
      </div>

      <!-- Section 2: Doctors Active -->
      <div class="dashboard-section">
        <div class="section-header">
          <h2>
            <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none"
              style="vertical-align:middle;margin-right:8px;">
              <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
            Doctors Active
          </h2>
        </div>
        <div id="doctorsList" class="list-container">
          <div class="skeleton skeleton-card"></div>
        </div>
        <div id="doctorsPagination" class="pagination-controls" style="display:none;"></div>
      </div>

      <!-- Section 3: Patients Assigned -->
      <div class="dashboard-section">
        <div class="section-header">
          <h2>
            <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none"
              style="vertical-align:middle;margin-right:8px;">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
            Patients Assigned
          </h2>
        </div>
        <div id="assignedList" class="list-container">
          <div class="skeleton skeleton-card"></div>
        </div>
        <div id="assignedPagination" class="pagination-controls" style="display:none;"></div>
      </div>

      <!-- Export -->
      <div style="margin-top:1.5rem;">
        <button class="btn btn-outline" id="exportBtn">&#128196; Export Report</button>
      </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <script src="../js/firebase-config.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/auth-guard.js"></script>
    <script src="../js/firestore.js"></script>
    <script src="../js/search-filter.js"></script>
    <script>
      requireAuth('admin').then(function (user) {
        var PAGE_SIZE = 5;
        var container = document.getElementById('submissionList');
        var doctorsContainer = document.getElementById('doctorsList');
        var assignedContainer = document.getElementById('assignedList');
        var allSubmissions = [];

        // ========== Pagination Helper ==========
        function renderPagination(paginationEl, totalItems, currentPage, onPageChange) {
          if (totalItems <= PAGE_SIZE) { paginationEl.style.display = 'none'; return; }
          paginationEl.style.display = 'flex';
          var totalPages = Math.ceil(totalItems / PAGE_SIZE);
          paginationEl.innerHTML = '';

          var prevBtn = document.createElement('button');
          prevBtn.className = 'btn btn-outline btn-sm';
          prevBtn.textContent = '← Prev';
          prevBtn.disabled = currentPage === 1;
          prevBtn.addEventListener('click', function () { onPageChange(currentPage - 1); });
          paginationEl.appendChild(prevBtn);

          var info = document.createElement('span');
          info.className = 'pagination-info';
          info.textContent = 'Page ' + currentPage + ' of ' + totalPages;
          paginationEl.appendChild(info);

          var nextBtn = document.createElement('button');
          nextBtn.className = 'btn btn-outline btn-sm';
          nextBtn.textContent = 'Next →';
          nextBtn.disabled = currentPage === totalPages;
          nextBtn.addEventListener('click', function () { onPageChange(currentPage + 1); });
          paginationEl.appendChild(nextBtn);
        }

        function getPage(items, page) {
          var start = (page - 1) * PAGE_SIZE;
          return items.slice(start, start + PAGE_SIZE);
        }

        // ========== Empty State Helper ==========
        function getEmptyState(title, message, icon) {
          return '<div class="empty-state">' +
            '<div class="empty-state-icon">' + icon + '</div>' +
            '<h3>' + title + '</h3>' +
            '<p>' + message + '</p>' +
            '</div>';
        }

        // Priority badge
        function getPriorityBadge(description) {
          var desc = (description || '').toLowerCase();
          if (desc.indexOf('urgent') !== -1 || desc.indexOf('severe') !== -1 || desc.indexOf('emergency') !== -1) {
            return '<span class="priority-badge priority-high">High</span>';
          }
          if (desc.indexOf('moderate') !== -1 || desc.indexOf('growing') !== -1 || desc.indexOf('pain') !== -1) {
            return '<span class="priority-badge priority-medium">Medium</span>';
          }
          return '<span class="priority-badge priority-low">Normal</span>';
        }

        // ========== Section 1: Patient Requests ==========
        var submissionPage = 1;
        function renderSubmissions(submissions) {
          if (submissions.length === 0) {
            container.innerHTML = getEmptyState('All Caught Up!', 'No pending patient submissions at the moment.',
              '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"></path><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"></path></svg>');
            document.getElementById('submissionPagination').style.display = 'none';
            return;
          }
          var pageItems = getPage(submissions, submissionPage);
          container.innerHTML = '';
          pageItems.forEach(function (sub) {
            var card = createElement('div', { className: 'card list-row' });
            var dateStr = sub.createdAt ? new Date(sub.createdAt.seconds * 1000).toLocaleDateString() : '';
            var typeLabel = sub.type === 'follow-up' ? ' <span class="badge badge-info">Follow-up</span>' : '';
            var priority = getPriorityBadge(sub.description);
            card.innerHTML = '<div class="list-row-info">' +
              '<div class="list-row-avatar">' + (sub.patientName || '?').charAt(0).toUpperCase() + '</div>' +
              '<div><strong>' + escapeHtml(sub.patientName) + '</strong> ' + priority + typeLabel +
              '<br><span class="text-muted">' + escapeHtml(sub.title) + ' &middot; ' + dateStr + '</span></div>' +
              '</div>' +
              '<div class="list-row-actions">' +
              '<a href="assign.html?id=' + sub.id + '&patientId=' + sub.patientId + '" class="btn btn-primary btn-sm">Assign</a>' +
              '</div>';
            container.appendChild(card);
          });
          renderPagination(document.getElementById('submissionPagination'), submissions.length, submissionPage, function (p) {
            submissionPage = p;
            renderSubmissions(submissions);
          });
        }

        // ========== Section 2: Doctors Active ==========
        var doctorPage = 1;
        function renderDoctors(doctors, appointments) {
          if (doctors.length === 0) {
            doctorsContainer.innerHTML = getEmptyState('No Oncologists', 'No oncologists registered yet.',
              '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-3-3.87"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path></svg>');
            document.getElementById('doctorsPagination').style.display = 'none';
            return;
          }
          var pageItems = getPage(doctors, doctorPage);
          doctorsContainer.innerHTML = '';
          pageItems.forEach(function (doc) {
            var patientCount = 0;
            (appointments || []).forEach(function (apt) {
              if (apt.doctorId === doc.uid && (apt.status === 'assigned' || apt.status === 'prescribed')) patientCount++;
            });
            var card = createElement('div', { className: 'card list-row' });
            var initials = (doc.name || '?').split(' ').map(function (w) { return w[0]; }).join('').toUpperCase().slice(0, 2);
            var spec = doc.specialization ? '<span class="badge badge-info">' + escapeHtml(doc.specialization) + '</span>' : '';
            card.innerHTML = '<div class="list-row-info">' +
              '<div class="list-row-avatar doctor-avatar"><span class="status-dot status-online"></span>' + initials + '</div>' +
              '<div><strong>Dr. ' + escapeHtml(doc.name) + '</strong> ' + spec + '</div>' +
              '</div>' +
              '<div class="list-row-meta"><span>' + patientCount + ' patient' + (patientCount !== 1 ? 's' : '') + '</span></div>';
            doctorsContainer.appendChild(card);
          });
          renderPagination(document.getElementById('doctorsPagination'), doctors.length, doctorPage, function (p) {
            doctorPage = p;
            renderDoctors(doctors, appointments);
          });
        }

        // ========== Section 3: Patients Assigned ==========
        var assignedPage = 1;
        function renderAssigned(appointments) {
          var assigned = (appointments || []).filter(function (a) { return a.status === 'assigned' || a.status === 'prescribed'; });
          if (assigned.length === 0) {
            assignedContainer.innerHTML = getEmptyState('No Assignments', 'No patients have been assigned to doctors yet.',
              '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M22 11l2 2-4 4"></path></svg>');
            document.getElementById('assignedPagination').style.display = 'none';
            return;
          }
          var pageItems = getPage(assigned, assignedPage);
          assignedContainer.innerHTML = '';
          pageItems.forEach(function (apt) {
            var card = createElement('div', { className: 'card list-row' });
            var statusClass = apt.status === 'prescribed' ? 'status-prescribed' : 'status-assigned';
            card.innerHTML = '<div class="list-row-info">' +
              '<div class="list-row-avatar">' + (apt.patientName || '?').charAt(0).toUpperCase() + '</div>' +
              '<div><strong>' + escapeHtml(apt.patientName) + '</strong> <span class="status ' + statusClass + '">' + apt.status + '</span></div>' +
              '</div>' +
              '<div class="list-row-meta"><span class="text-muted">&rarr; Dr. ' + escapeHtml(apt.doctorName) + '</span></div>';
            assignedContainer.appendChild(card);
          });
          renderPagination(document.getElementById('assignedPagination'), assigned.length, assignedPage, function (p) {
            assignedPage = p;
            renderAssigned(appointments);
          });
        }

        // ========== Real-time Stats ==========
        onStatsChange('admin', user.uid, function (stats) {
          if (stats.pendingCount !== undefined) document.getElementById('pendingCount').textContent = stats.pendingCount;
          if (stats.doctorCount !== undefined) document.getElementById('doctorCount').textContent = stats.doctorCount;
        });

        db.collection('users').where('role', '==', 'patient').get().then(function (snap) {
          document.getElementById('totalPatientCount').textContent = snap.size;
        });

        // ========== Load Data ==========
        var allDoctors = [];
        var allAppointments = [];
        var doctorsLoaded = false;
        var appointmentsLoaded = false;

        function refreshSections() {
          if (doctorsLoaded && appointmentsLoaded) {
            renderDoctors(allDoctors, allAppointments);
            renderAssigned(allAppointments);
          }
        }

        getDoctorList().then(function (doctors) {
          allDoctors = doctors;
          doctorsLoaded = true;
          refreshSections();
        });

        getAllAppointments().then(function (appointments) {
          allAppointments = appointments;
          appointmentsLoaded = true;
          refreshSections();
        });

        onSubmissionsChange(function (submissions) {
          allSubmissions = submissions;
          var searchText = document.getElementById('searchInput').value;
          submissionPage = 1;
          renderSubmissions(filterByText(submissions, searchText, 'patientName'));
        });

        document.getElementById('searchInput').addEventListener('input', function () {
          submissionPage = 1;
          renderSubmissions(filterByText(allSubmissions, this.value, 'patientName'));
        });

        // Export
        document.getElementById('exportBtn').addEventListener('click', function () {
          var lines = ['TumourCare Admin Report', 'Generated: ' + new Date().toLocaleString(), ''];
          lines.push('--- Patient Requests ---');
          allSubmissions.forEach(function (s) {
            lines.push(s.patientName + ' | ' + s.title + ' | ' + (s.createdAt ? new Date(s.createdAt.seconds * 1000).toLocaleDateString() : ''));
          });
          lines.push('');
          lines.push('--- Doctors Active ---');
          allDoctors.forEach(function (d) {
            lines.push('Dr. ' + d.name + ' | ' + (d.specialization || 'General Oncology'));
          });
          lines.push('');
          lines.push('--- Patients Assigned ---');
          allAppointments.filter(function (a) { return a.status === 'assigned' || a.status === 'prescribed'; }).forEach(function (a) {
            lines.push(a.patientName + ' -> Dr. ' + a.doctorName + ' | ' + a.scheduledDate + ' | ' + a.status);
          });
          var blob = new Blob([lines.join('\n')], { type: 'text/plain' });
          var url = URL.createObjectURL(blob);
          var a = document.createElement('a');
          a.href = url; a.download = 'tumourcare-report-' + today + '.txt'; a.click();
          URL.revokeObjectURL(url);
        });

        document.getElementById('logoutBtn').addEventListener('click', function (e) { e.preventDefault(); logoutUser(); });

        // Mobile Nav Toggle
        var navToggle = document.getElementById('navToggle');
        var navLinks = document.getElementById('navLinks');
        if (navToggle && navLinks) {
          navToggle.addEventListener('click', function () { navLinks.classList.toggle('open'); });
        }
      });
    </script>
  </main>
</body>

</html>