<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="../logo.png">
    <title>Manage Patients - TumourCare</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/admin-layout.css">
</head>

<body class="dashboard-body">
    <!-- Top Navbar -->
    <nav class="dashboard-topnav">
        <div class="topnav-inner">
            <a href="dashboard.html" class="topnav-brand">
                <img src="../logo.png" alt="TumourCare Logo">
                <span>TumourCare</span>
            </a>
            <button class="topnav-toggle" id="navToggle" aria-label="Toggle navigation">&#9776;</button>
            <div class="topnav-links" id="navLinks">
                <a href="dashboard.html">
                    <svg viewBox="0 0 24 24">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                    </svg>
                    Dashboard
                </a>
                <a href="manage-doctors.html">
                    <svg viewBox="0 0 24 24">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    Manage Doctors
                </a>
                <a href="manage-patients.html" class="active">
                    <svg viewBox="0 0 24 24">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    Manage Patients
                </a>
                <a href="notifications.html">
                    <svg viewBox="0 0 24 24">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                    </svg>
                    Notifications <span id="notifBadge" class="nav-badge" style="display:none;">0</span>
                </a>
            </div>
            <a href="#" id="logoutBtn" class="topnav-logout" title="Logout">
                <svg viewBox="0 0 24 24">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16 17 21 12 16 7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
                <span>Logout</span>
            </a>
        </div>
    </nav>

    <main class="main-content">
        <header class="page-header">
            <div>
                <h1>Manage Patients</h1>
                <div class="breadcrumb">View and manage all registered patients</div>
            </div>
        </header>

        <div class="page-body">
            <!-- Search -->
            <div class="dashboard-section">
                <div class="section-header">
                    <h2>
                        <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2"
                            fill="none" style="vertical-align:middle;margin-right:8px;">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                        </svg>
                        All Patients
                    </h2>
                    <div class="section-actions">
                        <input type="text" id="searchInput" placeholder="Search by name or email..."
                            class="search-input">
                    </div>
                </div>
                <div id="patientsList" class="list-container">
                    <div class="skeleton skeleton-card"></div>
                    <div class="skeleton skeleton-card"></div>
                    <div class="skeleton skeleton-card"></div>
                </div>
                <div id="patientsPagination" class="pagination-controls" style="display:none;"></div>
            </div>
        </div>

        <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
        <script src="../js/firebase-config.js"></script>
        <script src="../js/utils.js"></script>
        <script src="../js/auth.js"></script>
        <script src="../js/auth-guard.js"></script>
        <script src="../js/firestore.js"></script>
        <script>
            requireAuth('admin').then(function (user) {
                var PAGE_SIZE = 5;
                var container = document.getElementById('patientsList');
                var allPatients = [];
                var currentPage = 1;

                function getEmptyState(title, message, icon) {
                    return '<div class="empty-state">' +
                        '<div class="empty-state-icon">' + icon + '</div>' +
                        '<h3>' + title + '</h3>' +
                        '<p>' + message + '</p>' +
                        '</div>';
                }

                function renderPagination(totalItems, page, onPageChange) {
                    var paginationEl = document.getElementById('patientsPagination');
                    if (totalItems <= PAGE_SIZE) { paginationEl.style.display = 'none'; return; }
                    paginationEl.style.display = 'flex';
                    var totalPages = Math.ceil(totalItems / PAGE_SIZE);
                    paginationEl.innerHTML = '';

                    var prevBtn = document.createElement('button');
                    prevBtn.className = 'btn btn-outline btn-sm';
                    prevBtn.textContent = '← Prev';
                    prevBtn.disabled = page === 1;
                    prevBtn.addEventListener('click', function () { onPageChange(page - 1); });
                    paginationEl.appendChild(prevBtn);

                    var info = document.createElement('span');
                    info.className = 'pagination-info';
                    info.textContent = 'Page ' + page + ' of ' + totalPages;
                    paginationEl.appendChild(info);

                    var nextBtn = document.createElement('button');
                    nextBtn.className = 'btn btn-outline btn-sm';
                    nextBtn.textContent = 'Next →';
                    nextBtn.disabled = page === totalPages;
                    nextBtn.addEventListener('click', function () { onPageChange(page + 1); });
                    paginationEl.appendChild(nextBtn);
                }

                function renderPatients(patients) {
                    if (patients.length === 0) {
                        container.innerHTML = getEmptyState('No Patients Found',
                            'No patients match your search criteria.',
                            '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle></svg>');
                        document.getElementById('patientsPagination').style.display = 'none';
                        return;
                    }

                    var start = (currentPage - 1) * PAGE_SIZE;
                    var pageItems = patients.slice(start, start + PAGE_SIZE);
                    container.innerHTML = '';

                    pageItems.forEach(function (p) {
                        var card = document.createElement('div');
                        card.className = 'card list-row';
                        var initials = (p.name || '?').split(' ').map(function (w) { return w[0]; }).join('').toUpperCase().slice(0, 2);
                        var dateStr = p.createdAt ? new Date(p.createdAt.seconds * 1000).toLocaleDateString() : 'N/A';
                        var statusBadge = p.status === 'active'
                            ? '<span class="badge" style="background:rgba(16,185,129,0.15);color:#10b981;">Active</span>'
                            : '<span class="badge" style="background:rgba(245,158,11,0.15);color:#f59e0b;">Pending</span>';

                        card.innerHTML = '<div class="list-row-info">' +
                            '<div class="list-row-avatar">' + initials + '</div>' +
                            '<div>' +
                            '<strong>' + escapeHtml(p.name) + '</strong> ' + statusBadge +
                            '<br><span class="text-muted">' + escapeHtml(p.email) + ' &middot; Joined ' + dateStr + '</span>' +
                            '</div>' +
                            '</div>' +
                            '<div class="list-row-meta">' +
                            '<span class="text-muted">Patient</span>' +
                            '</div>';
                        container.appendChild(card);
                    });

                    renderPagination(patients.length, currentPage, function (p) {
                        currentPage = p;
                        renderPatients(patients);
                    });
                }

                // Load all patients
                db.collection('users').where('role', '==', 'patient').get().then(function (snap) {
                    snap.forEach(function (doc) {
                        var data = doc.data();
                        data.id = doc.id;
                        allPatients.push(data);
                    });
                    // Sort by name
                    allPatients.sort(function (a, b) {
                        return (a.name || '').localeCompare(b.name || '');
                    });
                    renderPatients(allPatients);
                }).catch(function (err) {
                    container.innerHTML = getEmptyState('Error Loading Patients',
                        'Could not load patient data. Please try again.',
                        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>');
                });

                // Search
                document.getElementById('searchInput').addEventListener('input', function () {
                    var query = this.value.toLowerCase();
                    currentPage = 1;
                    var filtered = allPatients.filter(function (p) {
                        return (p.name || '').toLowerCase().indexOf(query) !== -1 ||
                            (p.email || '').toLowerCase().indexOf(query) !== -1;
                    });
                    renderPatients(filtered);
                });

                document.getElementById('logoutBtn').addEventListener('click', function (e) { e.preventDefault(); logoutUser(); });

                var navToggle = document.getElementById('navToggle');
                var navLinks = document.getElementById('navLinks');
                if (navToggle && navLinks) {
                    navToggle.addEventListener('click', function () { navLinks.classList.toggle('open'); });
                }
            });
        </script>
    </main>
</body>

</html>