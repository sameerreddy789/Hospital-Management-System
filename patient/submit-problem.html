<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon"
    href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>&#127993;</text></svg>">
  <title>Submit Problem - TumourCare</title>
  <link rel="stylesheet" href="../css/style.css">
  <link rel="stylesheet" href="../css/patient-layout.css">
</head>

<body class="dashboard-body">
  <!-- Mobile Overlay -->
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <!-- Mobile Toggle -->
  <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle navigation">
    &#9776;
  </button>

  <!-- Sidebar -->
  <aside class="patient-sidebar" id="patientSidebar">
    <div class="sidebar-brand">
      <h2><span>&#127993;</span> TumourCare</h2>
    </div>

    <nav class="sidebar-nav">
      <a href="dashboard.html">
        <svg viewBox="0 0 24 24">
          <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
          <polyline points="9 22 9 12 15 12 15 22"></polyline>
        </svg>
        Dashboard
      </a>
      <a href="submit-problem.html" class="active">
        <svg viewBox="0 0 24 24">
          <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
          <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
        </svg>
        Submit Problem
      </a>
      <a href="appointments.html">
        <svg viewBox="0 0 24 24">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
        Appointments
      </a>
      <a href="prescriptions.html">
        <svg viewBox="0 0 24 24">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <line x1="16" y1="13" x2="8" y2="13"></line>
          <line x1="16" y1="17" x2="8" y2="17"></line>
          <polyline points="10 9 9 9 8 9"></polyline>
        </svg>
        Prescriptions
      </a>
      <a href="profile.html">
        <svg viewBox="0 0 24 24">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
          <circle cx="12" cy="7" r="4"></circle>
        </svg>
        Profile
      </a>
      <a href="notifications.html">
        <svg viewBox="0 0 24 24">
          <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
          <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
        </svg>
        Notifications <span id="notifBadge" class="nav-badge" style="display:none;">0</span>
      </a>
    </nav>

    <div class="sidebar-footer">
      <a href="#" id="logoutBtnSidebar">
        <svg viewBox="0 0 24 24">
          <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
          <polyline points="16 17 21 12 16 7"></polyline>
          <line x1="21" y1="12" x2="9" y2="12"></line>
        </svg>
        Logout
      </a>
    </div>
  </aside>

  <!-- Main Content Area -->
  <main class="main-content">
    <header class="page-header">
      <div>
        <h1 id="pageTitle">Submit a Medical Concern</h1>
        <div class="breadcrumb" id="pageBreadcrumb"><a href="dashboard.html">Dashboard</a> <span>›</span> Submit Medical
          Concern</div>
      </div>
    </header>

    <div class="page-body">
      <div class="card">
        <div id="message" class="message" style="display:none;"></div>
        <form id="problemForm" novalidate>

          <div class="form-group">
            <label for="primaryConcern">Primary Concern</label>
            <select id="primaryConcern" name="primaryConcern" required>
              <option value="">-- Select your concern --</option>
              <option value="New lump/swelling">New lump or swelling</option>
              <option value="Pain in specific area">Pain in a specific area</option>
              <option value="Follow-up consultation">Follow-up consultation</option>
              <option value="Report review">Report review</option>
              <option value="Treatment side effects">Treatment side effects</option>
              <option value="Post-surgery concern">Post-surgery concern</option>
              <option value="Second opinion">Second opinion</option>
              <option value="Other">Other</option>
            </select>
          </div>

          <div class="form-group">
            <label for="bodyArea">Affected Body Area</label>
            <select id="bodyArea" name="bodyArea" required>
              <option value="">-- Select affected area --</option>
              <option value="Breast">Breast</option>
              <option value="Brain">Brain</option>
              <option value="Lung">Lung</option>
              <option value="Oral">Oral</option>
              <option value="Neck">Neck</option>
              <option value="Abdomen">Abdomen</option>
              <option value="Bone">Bone</option>
              <option value="Skin">Skin</option>
              <option value="Other">Other</option>
            </select>
          </div>

          <div class="form-group">
            <label for="description">Describe Your Symptoms</label>
            <textarea id="description" name="description" rows="5"
              placeholder="Describe your symptoms in detail — include pain level changes, when they started, anything you've noticed, or concerns you'd like addressed."
              required></textarea>
          </div>

          <div class="form-group">
            <label>Pain Level</label>
            <div class="radio-group" id="painLevel">
              <label class="radio-option"><input type="radio" name="painLevel" value="None" checked><span
                  class="radio-label">None</span></label>
              <label class="radio-option"><input type="radio" name="painLevel" value="Mild"><span
                  class="radio-label">Mild</span></label>
              <label class="radio-option"><input type="radio" name="painLevel" value="Moderate"><span
                  class="radio-label">Moderate</span></label>
              <label class="radio-option"><input type="radio" name="painLevel" value="Severe"><span
                  class="radio-label">Severe</span></label>
            </div>
          </div>

          <div class="form-group">
            <label>How Urgent Is This?</label>
            <div class="radio-group" id="urgency">
              <label class="radio-option"><input type="radio" name="urgency" value="Routine" checked><span
                  class="radio-label">Routine</span></label>
              <label class="radio-option"><input type="radio" name="urgency" value="Soon"><span class="radio-label">Soon
                  (within a few days)</span></label>
              <label class="radio-option"><input type="radio" name="urgency" value="Urgent"><span
                  class="radio-label">Urgent (within 24 hrs)</span></label>
              <label class="radio-option"><input type="radio" name="urgency" value="Emergency"><span
                  class="radio-label">Emergency (severe pain / bleeding)</span></label>
            </div>
          </div>

          <div class="form-group" style="margin-top:1.25rem;">
            <label class="checkbox-option">
              <input type="checkbox" id="consent" required>
              <span>I confirm the information provided is accurate and I consent to share my medical details with the
                hospital specialists for review.</span>
            </label>
          </div>

          <button type="submit" class="btn btn-primary btn-lg btn-block" id="submitBtn">Submit Medical Concern</button>
        </form>
      </div>
    </div>
  </main>

  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="../js/firebase-config.js"></script>
  <script src="../js/utils.js"></script>
  <script src="../js/validation.js"></script>
  <script src="../js/auth.js"></script>
  <script src="../js/auth-guard.js"></script>
  <script src="../js/firestore.js"></script>
  <script src="../js/notifications.js"></script>
  <script>
    requireAuth('patient').then(function (user) {
      var form = document.getElementById('problemForm');
      var messageEl = document.getElementById('message');

      form.addEventListener('submit', function (e) {
        e.preventDefault();
        clearFieldErrors(form);
        messageEl.style.display = 'none';

        var primaryConcern = document.getElementById('primaryConcern').value;
        var bodyArea = document.getElementById('bodyArea').value;
        var description = document.getElementById('description').value;
        var painLevel = document.querySelector('input[name="painLevel"]:checked').value;
        var urgency = document.querySelector('input[name="urgency"]:checked').value;
        var consent = document.getElementById('consent').checked;

        // Validation
        var hasError = false;
        if (!primaryConcern) {
          showFieldError(document.getElementById('primaryConcern'), 'Please select your primary concern.');
          hasError = true;
        }
        if (!bodyArea) {
          showFieldError(document.getElementById('bodyArea'), 'Please select the affected body area.');
          hasError = true;
        }
        if (!description.trim()) {
          showFieldError(document.getElementById('description'), 'Please describe your symptoms.');
          hasError = true;
        }
        if (!consent) {
          showMessage(messageEl, 'Please confirm your consent before submitting.', 'error');
          hasError = true;
        }
        if (hasError) {
          window.scrollTo({ top: 0, behavior: 'smooth' });
          return;
        }

        // Auto-generate title for backward compatibility
        var title = primaryConcern + ' — ' + bodyArea;

        var submitBtn = document.getElementById('submitBtn');
        submitBtn.classList.add('btn-loading');
        submitBtn.disabled = true;

        createProblemSubmission(user.uid, title, description, 'initial', null, {
          primaryConcern: primaryConcern,
          bodyArea: bodyArea,
          painLevel: painLevel,
          urgency: urgency
        })
          .then(function () {
            db.collection('users').where('role', '==', 'admin').get().then(function (snap) {
              snap.forEach(function (doc) {
                createNotification(doc.id, 'New medical concern: ' + title + ' [' + urgency + ']', 'request');
              });
            });
            form.reset();

            // Show success popup
            var successModal = document.getElementById('successModal');
            if (!successModal) {
              successModal = document.createElement('div');
              successModal.id = 'successModal';
              successModal.className = 'modal';
              successModal.innerHTML =
                '<div class="modal-content" style="text-align:center;max-width:440px;">' +
                '<div style="width:64px;height:64px;border-radius:50%;background:linear-gradient(135deg,#10b981,#059669);display:flex;align-items:center;justify-content:center;margin:0 auto 1rem;"><span style="color:#fff;font-size:1.75rem;font-weight:700;">&#10003;</span></div>' +
                '<h2 style="margin-bottom:0.5rem;color:#1e293b;">Concern Submitted</h2>' +
                '<p style="color:#64748b;margin-bottom:1.5rem;line-height:1.6;">Your medical concern has been submitted successfully. Our oncology team will review it and schedule an appointment with the right specialist.</p>' +
                '<a href="dashboard.html" class="btn btn-primary">Back to Dashboard</a>' +
                '</div>';
              document.body.appendChild(successModal);
            }
            successModal.style.display = 'flex';
          })
          .catch(function (err) {
            showMessage(messageEl, err.message || 'Failed to submit. Please try again.', 'error');
          })
          .finally(function () {
            submitBtn.classList.remove('btn-loading');
            submitBtn.disabled = false;
          });
      });

      document.getElementById('logoutBtnSidebar').addEventListener('click', function (e) { e.preventDefault(); confirmLogout(); });
      var toggle = document.getElementById('sidebarToggle');
      var sidebar = document.getElementById('patientSidebar');
      var overlay = document.getElementById('sidebarOverlay');
      if (toggle && sidebar && overlay) {
        toggle.addEventListener('click', function () {
          sidebar.classList.add('open');
          overlay.classList.add('active');
        });
        overlay.addEventListener('click', function () {
          sidebar.classList.remove('open');
          overlay.classList.remove('active');
        });
      }
    });
  </script>
</body>

</html>