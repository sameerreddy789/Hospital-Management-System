<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Patient Details - Clinic Management</title>
  <link rel="stylesheet" href="../css/style.css">
</head>
<body>
  <nav class="navbar">
    <div class="nav-brand">Clinic Management</div>
    <button class="nav-toggle" aria-label="Toggle navigation">&#9776;</button>
    <div class="nav-links">
      <a href="dashboard.html">Dashboard</a>
      <a href="notifications.html">Notifications</a>
      <a href="#" id="logoutBtn">Logout</a>
    </div>
  </nav>

  <div class="container">
    <h1>Patient Details</h1>
    <div id="message" class="message" style="display:none;"></div>

    <!-- Patient Profile -->
    <div class="card" id="patientProfile">
      <h2>Patient Information</h2>
      <p>Name: <span id="pName">-</span></p>
      <p>Email: <span id="pEmail">-</span></p>
      <p>Phone: <span id="pPhone">-</span></p>
      <p>Address: <span id="pAddress">-</span></p>
    </div>

    <!-- Current Appointment -->
    <div class="card" id="currentAppointment">
      <h2>Current Appointment</h2>
      <p>Problem: <span id="aptProblem">-</span></p>
      <p>Description: <span id="aptDesc">-</span></p>
      <p>Date: <span id="aptDate">-</span></p>
      <p>Status: <span id="aptStatus" class="status">-</span></p>
      <div id="completeSection" style="display:none;">
        <button id="completeBtn" class="btn btn-primary">Mark as Completed</button>
      </div>
    </div>

    <!-- Prescription Form (only for assigned appointments) -->
    <div class="card" id="prescriptionSection" style="display:none;">
      <h2>Write Prescription</h2>
      <form id="prescriptionForm" novalidate>
        <div id="medicineRows">
          <div class="medicine-row">
            <div class="form-group">
              <label>Medicine Name</label>
              <input type="text" class="med-name" required>
            </div>
            <div class="form-group">
              <label>Dosage</label>
              <input type="text" class="med-dosage" placeholder="e.g., 500mg" required>
            </div>
            <div class="form-group">
              <label>Frequency</label>
              <input type="text" class="med-frequency" placeholder="e.g., Twice daily" required>
            </div>
          </div>
        </div>
        <button type="button" id="addMedicine" class="btn btn-outline">+ Add Medicine</button>
        <div class="form-group">
          <label for="notes">Additional Notes</label>
          <textarea id="notes" rows="3"></textarea>
        </div>
        <button type="submit" class="btn btn-primary">Submit Prescription</button>
      </form>
    </div>

    <!-- Patient History -->
    <div class="card">
      <h2>Patient History</h2>
      <div id="historyList" class="list-container">
        <p class="loading">Loading...</p>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="../js/firebase-config.js"></script>
  <script src="../js/utils.js"></script>
  <script src="../js/validation.js"></script>
  <script src="../js/auth.js"></script>
  <script src="../js/auth-guard.js"></script>
  <script src="../js/firestore.js"></script>
  <script>
    requireAuth('doctor').then(function(user) {
      var params = new URLSearchParams(window.location.search);
      var appointmentId = params.get('appointmentId');
      var patientId = params.get('patientId');
      var messageEl = document.getElementById('message');

      if (!appointmentId || !patientId) {
        showMessage(messageEl, 'Invalid request.', 'error');
        return;
      }

      // Load patient profile
      getUserProfile(patientId).then(function(profile) {
        if (profile) {
          document.getElementById('pName').textContent = profile.name || '-';
          document.getElementById('pEmail').textContent = profile.email || '-';
          document.getElementById('pPhone').textContent = profile.phone || '-';
          document.getElementById('pAddress').textContent = profile.address || '-';
        }
      });

      // Load current appointment
      db.collection('appointments').doc(appointmentId).get().then(function(doc) {
        if (!doc.exists) return;
        var apt = doc.data();
        document.getElementById('aptProblem').textContent = apt.problemTitle || '-';
        document.getElementById('aptDesc').textContent = apt.problemDescription || '-';
        document.getElementById('aptDate').textContent = formatDate(apt.scheduledDate) + ' at ' + formatTime(apt.scheduledTime);
        document.getElementById('aptStatus').textContent = apt.status;
        document.getElementById('aptStatus').className = 'status status-' + apt.status;

        if (apt.status === 'assigned') {
          document.getElementById('prescriptionSection').style.display = 'block';
        }
        if (apt.status === 'prescribed') {
          document.getElementById('completeSection').style.display = 'block';
        }
      });

      // Load patient history
      getPatientHistory(patientId).then(function(history) {
        var container = document.getElementById('historyList');
        var items = [];
        history.appointments.forEach(function(a) {
          items.push({ type: 'appointment', date: a.scheduledDate, data: a });
        });
        history.prescriptions.forEach(function(p) {
          var d = p.createdAt ? new Date(p.createdAt.seconds * 1000).toISOString().split('T')[0] : '0000-00-00';
          items.push({ type: 'prescription', date: d, data: p });
        });
        items.sort(function(a, b) { return b.date.localeCompare(a.date); });

        if (items.length === 0) { container.innerHTML = '<p>No history.</p>'; return; }
        container.innerHTML = '';
        items.forEach(function(item) {
          var card = createElement('div', { className: 'card card-sm' });
          if (item.type === 'appointment') {
            card.innerHTML = '<p><strong>Appointment</strong> - ' + formatDate(item.data.scheduledDate) + '</p>' +
              '<p>' + item.data.problemTitle + ' | Status: ' + item.data.status + '</p>';
          } else {
            var meds = (item.data.medicines || []).map(function(m) { return m.name; }).join(', ');
            card.innerHTML = '<p><strong>Prescription</strong> - ' + formatDate(item.date) + '</p>' +
              '<p>Medicines: ' + meds + '</p>';
          }
          container.appendChild(card);
        });
      });

      // Add medicine row
      document.getElementById('addMedicine').addEventListener('click', function() {
        var row = document.createElement('div');
        row.className = 'medicine-row';
        row.innerHTML = '<div class="form-group"><label>Medicine Name</label><input type="text" class="med-name" required></div>' +
          '<div class="form-group"><label>Dosage</label><input type="text" class="med-dosage" placeholder="e.g., 500mg" required></div>' +
          '<div class="form-group"><label>Frequency</label><input type="text" class="med-frequency" placeholder="e.g., Twice daily" required></div>' +
          '<button type="button" class="btn btn-danger btn-sm remove-med">Remove</button>';
        document.getElementById('medicineRows').appendChild(row);
        row.querySelector('.remove-med').addEventListener('click', function() { row.remove(); });
      });

      // Submit prescription
      document.getElementById('prescriptionForm').addEventListener('submit', function(e) {
        e.preventDefault();
        var names = document.querySelectorAll('.med-name');
        var dosages = document.querySelectorAll('.med-dosage');
        var freqs = document.querySelectorAll('.med-frequency');
        var medicines = [];
        for (var i = 0; i < names.length; i++) {
          if (!names[i].value.trim()) { showMessage(messageEl, 'Please fill in all medicine fields.', 'error'); return; }
          medicines.push({ name: names[i].value.trim(), dosage: dosages[i].value.trim(), frequency: freqs[i].value.trim() });
        }
        if (medicines.length === 0) { showMessage(messageEl, 'At least one medicine is required.', 'error'); return; }
        var notes = document.getElementById('notes').value;

        createPrescription(appointmentId, patientId, user.uid, medicines, notes)
          .then(function() { return updateAppointmentStatus(appointmentId, 'prescribed'); })
          .then(function() {
            showMessage(messageEl, 'Prescription submitted successfully!', 'success');
            document.getElementById('prescriptionSection').style.display = 'none';
            document.getElementById('aptStatus').textContent = 'prescribed';
            document.getElementById('aptStatus').className = 'status status-prescribed';
            document.getElementById('completeSection').style.display = 'block';
          })
          .catch(function(err) { showMessage(messageEl, err.message || 'Failed to submit prescription.', 'error'); });
      });

      // Mark as completed
      document.getElementById('completeBtn').addEventListener('click', function() {
        updateAppointmentStatus(appointmentId, 'completed').then(function() {
          showMessage(messageEl, 'Appointment marked as completed.', 'success');
          document.getElementById('completeSection').style.display = 'none';
          document.getElementById('aptStatus').textContent = 'completed';
          document.getElementById('aptStatus').className = 'status status-completed';
        }).catch(function(err) { showMessage(messageEl, err.message, 'error'); });
      });

      document.getElementById('logoutBtn').addEventListener('click', function(e) { e.preventDefault(); logoutUser(); });
      var toggle = document.querySelector('.nav-toggle');
      var navLinks = document.querySelector('.nav-links');
      if (toggle) toggle.addEventListener('click', function() { navLinks.classList.toggle('nav-open'); });
    });
  </script>
</body>
</html>
